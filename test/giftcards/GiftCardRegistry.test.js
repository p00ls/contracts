const { ethers } = require('hardhat');
const { expect, util } = require('chai');

const { prepare, utils } = require('../fixture.js');

const name = 'MockName';
const symbol = 'MckSmbl';
const uri = 'https://someapi.com/tokenId/';
const fee = ethers.utils.parseEther('1.0');

const FACTORY  = { address: '0x4e59b44847b379578588920ca78fbf26c0b4956c', tx: '0xf8a58085174876e800830186a08080b853604580600e600039806000f350fe7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe03601600081602082378035828234f58015156039578182fd5b8082525050506014600cf31ba02222222222222222222222222222222222222222222222222222222222222222a02222222222222222222222222222222222222222222222222222222222222222' };
const REGISTRY = { address: '0x000000006551c19487814612e58FE06813775758', data: '0x0000000000000000000000000000000000000000fd8eb4e1dca713016c518e31608060405234801561001057600080fd5b5061023b806100206000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c8063246a00211461003b5780638a54c52f1461006a575b600080fd5b61004e6100493660046101b7565b61007d565b6040516001600160a01b03909116815260200160405180910390f35b61004e6100783660046101b7565b6100e1565b600060806024608c376e5af43d82803e903d91602b57fd5bf3606c5285605d52733d60ad80600a3d3981f3363d3d373d3d3d363d7360495260ff60005360b76055206035523060601b60015284601552605560002060601b60601c60005260206000f35b600060806024608c376e5af43d82803e903d91602b57fd5bf3606c5285605d52733d60ad80600a3d3981f3363d3d373d3d3d363d7360495260ff60005360b76055206035523060601b600152846015526055600020803b61018b578560b760556000f580610157576320188a596000526004601cfd5b80606c52508284887f79f19b3655ee38b1ce526556b7731a20c8f218fbda4a3990b6cc4172fdf887226060606ca46020606cf35b8060601b60601c60005260206000f35b80356001600160a01b03811681146101b257600080fd5b919050565b600080600080600060a086880312156101cf57600080fd5b6101d88661019b565b945060208601359350604086013592506101f46060870161019b565b94979396509194608001359291505056fea2646970667358221220ea2fe53af507453c64dd7c1db05549fa47a298dfb825d6d11e1689856135f16764736f6c63430008110033' };
const PROXY    = { address: '0x55266d75D1a14E4572138116aF39863Ed6596E7F', data: '0x655165516551655165516551655165516551655165516551655165516551655160c060405234801561001057600080fd5b5060405161047938038061047983398101604081905261002f9161009d565b6001600160a01b038216158061004c57506001600160a01b038116155b1561006a5760405163340aafcd60e11b815260040160405180910390fd5b6001600160a01b039182166080521660a0526100d0565b80516001600160a01b038116811461009857600080fd5b919050565b600080604083850312156100b057600080fd5b6100b983610081565b91506100c760208401610081565b90509250929050565b60805160a0516103866100f36000396000606d0152600060c301526103866000f3fe6080604052600436106100225760003560e01c8063c4d66de81461003957610031565b366100315761002f610059565b005b61002f610059565b34801561004557600080fd5b5061002f6100543660046102fe565b61006b565b6100696100646101b0565b6101e8565b565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316816001600160a01b03161461014b57604051631506fd4d60e01b81526001600160a01b0382811660048301527f00000000000000000000000000000000000000000000000000000000000000001690631506fd4d90602401602060405180830381865afa15801561010a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061012e919061032e565b61014b5760405163340aafcd60e11b815260040160405180910390fd5b600061017e7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc546001600160a01b031690565b6001600160a01b0316146101a45760405162dc149f60e41b815260040160405180910390fd5b6101ad8161020c565b50565b60006101e37f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc546001600160a01b031690565b905090565b3660008037600080366000845af43d6000803e808015610207573d6000f35b3d6000fd5b6102158161024c565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b6001600160a01b0381163b6102bd5760405162461bcd60e51b815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b606482015260840160405180910390fd5b7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80546001600160a01b0319166001600160a01b0392909216919091179055565b60006020828403121561031057600080fd5b81356001600160a01b038116811461032757600080fd5b9392505050565b60006020828403121561034057600080fd5b8151801515811461032757600080fdfea26469706673582212200e14e6944c0aa9246a2cf9c56026abac236e63d6d50c86664b79dfd650b8c6c064736f6c634300081100330000000000000000000000002fe5ccb0d7ea195feb87987d3573f9fcce2b5d5700000000000000000000000041c8f39463a868d3a88af00cd0fe7102f30e44ec' };
const ACCOUNT  = { address: '0x41C8f39463A868d3A88af00cd0fe7102F30E44eC', data: '0x65516551655165516551655165516551655165516551655165516551655165516101406040523060a0819052610120523480156200001c57600080fd5b5060405162003c5138038062003c518339810160408190526200003f916200010b565b8383838382828181876001600160a01b0381166200007057604051632039d3c960e01b815260040160405180910390fd5b6001600160a01b0390811660805281166200009d576040516246a29560e81b815260040160405180910390fd5b6001600160a01b0390811660c05290811660e0528216620000d15760405163754c753360e11b815260040160405180910390fd5b50506001600160a01b031661010052506200016895505050505050565b80516001600160a01b03811681146200010657600080fd5b919050565b600080600080608085870312156200012257600080fd5b6200012d85620000ee565b93506200013d60208601620000ee565b92506200014d60408601620000ee565b91506200015d60608601620000ee565b905092959194509250565b60805160a05160c05160e0516101005161012051613a4c6200020560003960008181610ca701528181610cf001528181610f8f01528181610fcf0152611100015260008181611a900152611e6b015260006111a801526000818161025a01528181610a63015261243f015260008181610a84015261241e0152600081816104eb0152818161149a015281816119d901526120960152613a4c6000f3fe6080604052600436106101dc5760003560e01c8063523e326011610102578063bc197c8111610095578063dd46706411610064578063dd4670641461058f578063ee9c6054146105af578063f23a6e61146105f0578063fc0c546a14610610576101eb565b8063bc197c811461052f578063c19d93fb1461054f578063ce0617ec14610564578063d087d2881461057a576101eb565b80638da5cb5b116100d15780638da5cb5b146104b0578063a4e2d634146104c5578063b0d691fe146104dc578063b709467c1461050f576101eb565b8063523e32601461043b57806352d1902d1461045b578063572b6c05146104705780637a8f735614610490576101eb565b80631fb1ecf01161017a57806343629a731161014957806343629a73146103d557806345a24e3e146103f55780634f1ef286146104155780635194544714610428576101eb565b80631fb1ecf01461035557806334715fb1146103755780633659cfe6146103955780633a871cdd146103b5576101eb565b8063150b7a02116101b6578063150b7a02146102945780631626ba7e146102cd5780631e2eaeaf146102ed5780631f9838b51461031a576101eb565b806301ffc9a7146101f3578063039721b114610228578063056d5afe14610248576101eb565b366101eb576101e9610648565b005b6101e9610648565b3480156101ff57600080fd5b5061021361020e366004612d33565b610751565b60405190151581526020015b60405180910390f35b34801561023457600080fd5b506101e9610243366004612d92565b61077f565b34801561025457600080fd5b5061027c7f000000000000000000000000000000000000000000000000000000000000000081565b6040516001600160a01b03909116815260200161021f565b3480156102a057600080fd5b506102b46102af366004612ec7565b61096d565b6040516001600160e01b0319909116815260200161021f565b3480156102d957600080fd5b506102b46102e8366004612f73565b6109e0565b3480156102f957600080fd5b5061030c610308366004612fbe565b5490565b60405190815260200161021f565b34801561032657600080fd5b50610213610335366004612fd7565b600260209081526000928352604080842090915290825290205460ff1681565b610368610363366004613021565b610a0b565b60405161021f9190613140565b34801561038157600080fd5b5061027c610390366004613153565b610c7e565b3480156103a157600080fd5b506101e96103b0366004613199565b610c9d565b3480156103c157600080fd5b5061030c6103d03660046131b6565b610d85565b6103e86103e3366004613209565b610da4565b60405161021f919061324a565b34801561040157600080fd5b5061027c610410366004612f73565b610f3b565b6101e96104233660046132ac565b610f85565b6103686104363660046132fb565b611055565b34801561044757600080fd5b506102b461045636600461336b565b61109e565b34801561046757600080fd5b5061030c6110f3565b34801561047c57600080fd5b5061021361048b366004613199565b6111a6565b34801561049c57600080fd5b506101e96104ab366004612d92565b6111d8565b3480156104bc57600080fd5b5061027c611408565b3480156104d157600080fd5b506000544210610213565b3480156104e857600080fd5b507f000000000000000000000000000000000000000000000000000000000000000061027c565b34801561051b57600080fd5b5061036861052a3660046133a6565b61142f565b34801561053b57600080fd5b506102b461054a36600461345d565b61147a565b34801561055b57600080fd5b5060035461030c565b34801561057057600080fd5b5061030c60005481565b34801561058657600080fd5b5061030c611496565b34801561059b57600080fd5b506101e96105aa366004612fbe565b61152f565b3480156105bb57600080fd5b5061027c6105ca36600461350a565b60016020908152600092835260408084209091529082529020546001600160a01b031681565b3480156105fc57600080fd5b506102b461060b36600461353f565b611616565b34801561061c57600080fd5b50610625611632565b604080519384526001600160a01b0390921660208401529082015260600161021f565b600080600061065561164a565b9250925092506000610668848484611658565b6001600160a01b0380821660009081526001602090815260408083206001600160e01b0319843516845290915290205491925016801561074a5760006106ad30611674565b9050600080826001600160a01b031684600036336040516020016106d494939291906135a7565b60408051601f19818403018152908290526106ee916135e5565b6000604051808303816000865af19150503d806000811461072b576040519150601f19603f3d011682016040523d82523d6000602084013e610730565b606091505b50915091508161074257805160208201fd5b805160208201f35b5050505050565b60008061075d836116af565b9050801561076e5750600192915050565b6107766116d4565b50600092915050565b600080600061078c61164a565b925092509250600061079f848484611658565b90506001600160a01b0381166107c85760405163ea8e4eb560e01b815260040160405180910390fd5b336001600160a01b038216146107f15760405163ea8e4eb560e01b815260040160405180910390fd5b6107f9611787565b8685811461081a5760405163b4fa3fb360e01b815260040160405180910390fd5b60005b818110156109615787878281811061083757610837613601565b905060200201602081019061084c9190613625565b6001600160a01b0384166000908152600260205260408120908c8c8581811061087757610877613601565b905060200201602081019061088c9190613199565b6001600160a01b031681526020810191909152604001600020805460ff19169115159190911790557f394777a58092892d136a90c4bb7e4350c72ac50fba6a0208128677f36527dcf5838b8b848181106108e8576108e8613601565b90506020020160208101906108fd9190613199565b8a8a8581811061090f5761090f613601565b90506020020160208101906109249190613625565b604080516001600160a01b03948516815293909216602084015215159082015260600160405180910390a18061095981613658565b91505061081d565b50505050505050505050565b60008060008061097b61164a565b91945092509050336001600160a01b03831614801561099957508086145b80156109a457504683145b156109c25760405163b79e3f3f60e01b815260040160405180910390fd5b6109ca610648565b50630a85bd0160e11b925050505b949350505050565b60006109ed8484846117b4565b15610a005750630b135d3f60e11b610a04565b5060005b9392505050565b6060816000610a18611941565b90503660005b83811015610c3357868682818110610a3857610a38613601565b90506060020191506000826020016020810190610a559190613199565b905060408301356000610aad7f00000000000000000000000000000000000000000000000000000000000000007f0000000000000000000000000000000000000000000000000000000000000000873546878761194b565b9050826001600160a01b03163b600003610ada57604051631052dd2560e21b815260040160405180910390fd5b6001600160a01b0381163b15610b6a57806001600160a01b031663a4e2d6346040518163ffffffff1660e01b8152600401602060405180830381865afa158015610b28573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b4c9190613671565b15610b6a57604051636315bfbb60e01b815260040160405180910390fd5b6040516331a9108f60e11b8152600481018390526001600160a01b03841690636352211e90602401602060405180830381865afa925050508015610bcb575060408051601f3d908101601f19168201909252610bc89181019061368e565b60015b610be857604051631052dd2560e21b815260040160405180910390fd5b866001600160a01b0316816001600160a01b031614610c1a57604051631052dd2560e21b815260040160405180910390fd5b509450829150610c2b905081613658565b915050610a1e565b50610c3d826119d5565b610c5a5760405163ea8e4eb560e01b815260040160405180910390fd5b610c62611787565b610c6f8b8b8b8b8b611bbd565b9b9a5050505050505050505050565b6000610c88611d99565b610c9485858585611dd3565b95945050505050565b6001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163003610cee5760405162461bcd60e51b8152600401610ce5906136ab565b60405180910390fd5b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316610d376000805160206139d0833981519152546001600160a01b031690565b6001600160a01b031614610d5d5760405162461bcd60e51b8152600401610ce5906136f7565b610d6681611e4c565b60408051600080825260208201909252610d8291839190611f1b565b50565b6000610d8f61208b565b610d998484612103565b9050610a048261213b565b6060610db6610db1611941565b6119d5565b610dd35760405163ea8e4eb560e01b815260040160405180910390fd5b610ddb611787565b816000816001600160401b03811115610df657610df6612e12565b604051908082528060200260200182016040528015610e2957816020015b6060815260200190600190039081610e145790505b50905060005b82811015610f3057610f00868683818110610e4c57610e4c613601565b9050602002810190610e5e9190613743565b610e6c906020810190613199565b878784818110610e7e57610e7e613601565b9050602002810190610e909190613743565b60200135888885818110610ea657610ea6613601565b9050602002810190610eb89190613743565b610ec6906040810190613759565b8a8a87818110610ed857610ed8613601565b9050602002810190610eea9190613743565b610efb90608081019060600161379f565b611bbd565b828281518110610f1257610f12613601565b60200260200101819052508080610f2890613658565b915050610e2f565b509150505b92915050565b6000610f45611d99565b6109d88484848080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061218892505050565b6001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000163003610fcd5760405162461bcd60e51b8152600401610ce5906136ab565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03166110166000805160206139d0833981519152546001600160a01b031690565b6001600160a01b03161461103c5760405162461bcd60e51b8152600401610ce5906136f7565b61104582611e4c565b61105182826001611f1b565b5050565b6060611062610db1611941565b61107f5760405163ea8e4eb560e01b815260040160405180910390fd5b611087611787565b6110948686868686611bbd565b9695505050505050565b60006110e08484848080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152506121c592505050565b15610a005750630291f19360e51b610a04565b6000306001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146111935760405162461bcd60e51b815260206004820152603860248201527f555550535570677261646561626c653a206d757374206e6f742062652063616c60448201527f6c6564207468726f7567682064656c656761746563616c6c00000000000000006064820152608401610ce5565b506000805160206139d083398151915290565b7f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0390811691161490565b60008060006111e561164a565b92509250925060006111f8848484611658565b90506001600160a01b0381166112215760405163ea8e4eb560e01b815260040160405180910390fd5b336001600160a01b0382161461124a5760405163ea8e4eb560e01b815260040160405180910390fd5b611252611787565b600061125d30611674565b9050806001600160a01b03163b60000361127a5761127a30612273565b8786811461129b5760405163b4fa3fb360e01b815260040160405180910390fd5b60005b818110156113fb578888828181106112b8576112b8613601565b90506020020160208101906112cd9190613199565b6001600160a01b0385166000908152600160205260408120908d8d858181106112f8576112f8613601565b905060200201602081019061130d9190612d33565b6001600160e01b0319168152602081019190915260400160002080546001600160a01b0319166001600160a01b03929092169190911790557f2c722487e90aca38ec1b074c3403210bd2bfb769b4da7f12f7bf0b9e37517c18848c8c8481811061137957611379613601565b905060200201602081019061138e9190612d33565b8b8b858181106113a0576113a0613601565b90506020020160208101906113b59190613199565b604080516001600160a01b0394851681526001600160e01b031993909316602084015292168183015290519081900360600190a1806113f381613658565b91505061129e565b5050505050505050505050565b60008060008061141661164a565b9250925092506114278383836122a7565b935050505090565b6060611439611d99565b610c94858585858080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061234692505050565b6000611484610648565b5063bc197c8160e01b95945050505050565b60007f0000000000000000000000000000000000000000000000000000000000000000604051631aab3f0d60e11b8152306004820152600060248201526001600160a01b0391909116906335567e1a90604401602060405180830381865afa158015611506573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061152a91906137ba565b905090565b600080600061153c61164a565b925092509250600061154f848484611658565b90506001600160a01b0381166115785760405163ea8e4eb560e01b815260040160405180910390fd5b336001600160a01b038216146115a15760405163ea8e4eb560e01b815260040160405180910390fd5b6115af426301e133806137d3565b8511156115cf576040516301814f7d60e31b815260040160405180910390fd5b6115d7611787565b60008590556040518581527fa7b24c66dd3269a292a60b3facdbb8f3e7557d1e19e64d99e0d6ee7250be63ad9060200160405180910390a15050505050565b6000611620610648565b5063f23a6e6160e01b95945050505050565b600080600061163f61164a565b925092509250909192565b600080600061163f306123bf565b6000806116668585856122a7565b9050610c9481868686612414565b6000610f357f97f795a08410e77dc9dbbaba3915f17c601e45642518dd578bd440d8775bfee46116a3846124e3565b8051906020012061254e565b60006001600160e01b03198216635194544760e01b1480610f355750610f358261255b565b60008060006116e161164a565b92509250925060006116f4848484611658565b6001600160a01b0380821660009081526001602090815260408083206001600160e01b0319843516845290915290205491925016801561074a57600080826001600160a01b031660003660405161174c9291906137e6565b600060405180830381855afa9150503d806000811461072b576040519150601f19603f3d011682016040523d82523d6000602084013e610730565b6000544210156117aa57604051636315bfbb60e01b815260040160405180910390fd5b6117b2612580565b565b600080838360408181106117ca576117ca613601565b919091013560f81c9150600090508181036118b1576117ed6020600086886137f6565b6117f691613820565b60001c905061181481604051806020016040528060008152506121c5565b15801561182a57506001600160a01b0381163014155b1561183a57600092505050610a04565b366000868661184d6040602083856137f6565b61185691613820565b6118619282906137f6565b915091506118a6838984848080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152506125ba92505050565b945050505050610a04565b60006118f38787878080601f0160208091040260200160405190810160405280939291908181526020018383808284376000920191909152506126a692505050565b9092509050600081600481111561190c5761190c61383e565b1461191d5760009350505050610a04565b61193682604051806020016040528060008152506121c5565b979650505050505050565b600061152a6126eb565b6040805160b78082018490526001600160a01b038516609783015260778201869052605782018790526e5af43d82803e903d91602b57fd5bf3603783015260288201889052733d60ad80600a3d3981f3363d3d373d3d3d363d736014830152815260d7810190915280516020909101206000906119c986828a61271a565b98975050505050505050565b60007f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316826001600160a01b031603611a1857506001919050565b6000806000611a2561164a565b925092509250468314611b0b5730611a58611a3e611941565b731111000000000000000000000000000000001110190190565b6001600160a01b031603611a7157506001949350505050565b6040516333932be560e11b81526001600160a01b0386811660048301527f0000000000000000000000000000000000000000000000000000000000000000169063672657ca90602401602060405180830381865afa158015611ad7573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611afb9190613671565b15611b0b57506001949350505050565b6000611b188484846122a7565b9050806001600160a01b0316866001600160a01b031603611b3f5750600195945050505050565b6000611b4d82868686612414565b9050806001600160a01b0316876001600160a01b031603611b75575060019695505050505050565b6001600160a01b038082166000908152600260209081526040808320938b168352929052205460ff1615611bb0575060019695505050505050565b5060009695505050505050565b606060ff8216611c0f57611c08868686868080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061234692505050565b9050610c94565b60001960ff831601611c79576000611c2630611674565b9050806001600160a01b03163b600003611c4357611c4330612273565b611c718187898888604051602001611c5d93929190613854565b604051602081830303815290604052612346565b915050610c94565b60011960ff831601611cfe57611cc58585858080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525061218892505050565b604051602001611ce8919060609190911b6001600160601b031916815260140190565b6040516020818303038152906040529050610c94565b60021960ff831601611d80576000611d1960208286886137f6565b611d2291613820565b9050366000611d34866020818a6137f6565b91509150611d4488848484611dd3565b604051602001611d67919060609190911b6001600160601b031916815260140190565b6040516020818303038152906040529350505050610c94565b604051631cc6a69960e11b815260040160405180910390fd5b611da230611674565b6001600160a01b0316336001600160a01b0316146117b25760405163ea8e4eb560e01b815260040160405180910390fd5b60008083838080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525050825192935087929150506020830188f591506001600160a01b038216611e435760405163a28c247360e01b815260040160405180910390fd5b50949350505050565b604051631506fd4d60e01b81526001600160a01b0382811660048301527f00000000000000000000000000000000000000000000000000000000000000001690631506fd4d90602401602060405180830381865afa158015611eb2573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611ed69190613671565b611ef35760405163340aafcd60e11b815260040160405180910390fd5b611efe610db1611941565b610d825760405163ea8e4eb560e01b815260040160405180910390fd5b7f4910fdfa16fed3260ed0e7147f7cc6da11a60208b5b9406d12a635614ffd91435460ff1615611f5357611f4e83612744565b505050565b826001600160a01b03166352d1902d6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015611fad575060408051601f3d908101601f19168201909252611faa918101906137ba565b60015b6120105760405162461bcd60e51b815260206004820152602e60248201527f45524331393637557067726164653a206e657720696d706c656d656e7461746960448201526d6f6e206973206e6f74205555505360901b6064820152608401610ce5565b6000805160206139d0833981519152811461207f5760405162461bcd60e51b815260206004820152602960248201527f45524331393637557067726164653a20756e737570706f727465642070726f786044820152681a58589b195555525160ba1b6064820152608401610ce5565b50611f4e8383836127e0565b336001600160a01b037f000000000000000000000000000000000000000000000000000000000000000016146117b25760405162461bcd60e51b815260206004820152601c60248201527f6163636f756e743a206e6f742066726f6d20456e747279506f696e74000000006044820152606401610ce5565b6000612125612112848461280b565b612120610140860186613759565b6117b4565b1561213257506000610f35565b50600192915050565b8015610d8257604051600090339060001990849084818181858888f193505050503d806000811461074a576040519150601f19603f3d011682016040523d82523d6000602084013e61074a565b805160009082906020820185f091506001600160a01b0382166121be5760405163a28c247360e01b815260040160405180910390fd5b5092915050565b6000806000806121d361164a565b92509250925060006121e68484846122a7565b9050806001600160a01b0316876001600160a01b03160361220e576001945050505050610f35565b600061221c82868686612414565b9050806001600160a01b0316886001600160a01b03160361224557600195505050505050610f35565b6001600160a01b038082166000908152600260209081526040808320938c168352929052205460ff166119c9565b61105160007f97f795a08410e77dc9dbbaba3915f17c601e45642518dd578bd440d8775bfee46122a2846124e3565b61283f565b60004684146122b857506000610a04565b826001600160a01b03163b6000036122d257506000610a04565b6040516331a9108f60e11b8152600481018390526001600160a01b03841690636352211e90602401602060405180830381865afa925050508015612333575060408051601f3d908101601f191682019092526123309181019061368e565b60015b61233f57506000610a04565b9050610a04565b60606000846001600160a01b0316848460405161236391906135e5565b60006040518083038185875af1925050503d80600081146123a0576040519150601f19603f3d011682016040523d82523d6000602084013e6123a5565b606091505b5092509050806123b757815160208301fd5b509392505050565b60408051606080825260808201909252600091829182918291906020820181803683370190505090506060604d60208301873c808060200190518101906124069190613880565b935093509350509193909250565b6000845b612463817f00000000000000000000000000000000000000000000000000000000000000007f0000000000000000000000000000000000000000000000000000000000000000612943565b15610c9457806001600160a01b031663fc0c546a6040518163ffffffff1660e01b8152600401606060405180830381865afa1580156124a6573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906124ca9190613880565b919650945092506124dc8585856122a7565b9050612418565b60606040518060400160405280600e81526020016d604380600d600039806000f3fe7360901b815250826040518060600160405280602e81526020016139a2602e9139604051602001612538939291906138b9565b6040516020818303038152906040529050919050565b6000610a0483833061271a565b60006001600160e01b03198216636faff5f160e01b1480610f355750610f35826129f2565b60035461258b612a27565b60405160200161259d93929190613900565b60408051601f198184030181529190528051602090910120600355565b6000806000856001600160a01b0316631626ba7e60e01b86866040516024016125e4929190613936565b60408051601f198184030181529181526020820180516001600160e01b03166001600160e01b031990941693909317909252905161262291906135e5565b600060405180830381855afa9150503d806000811461265d576040519150601f19603f3d011682016040523d82523d6000602084013e612662565b606091505b509150915081801561267657506020815110155b801561109457508051630b135d3f60e11b9061269b90830160209081019084016137ba565b149695505050505050565b60008082516041036126dc5760208301516040840151606085015160001a6126d087828585612a3a565b945094505050506126e4565b506000905060025b9250929050565b60006126f6336111a6565b8015612703575060143610155b15612715575060131936013560601c90565b503390565b6000604051836040820152846020820152828152600b8101905060ff815360559020949350505050565b6001600160a01b0381163b6127b15760405162461bcd60e51b815260206004820152602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b6064820152608401610ce5565b6000805160206139d083398151915280546001600160a01b0319166001600160a01b0392909216919091179055565b6127e983612afe565b6000825111806127f65750805b15611f4e576128058383612b3e565b50505050565b7f19457468657265756d205369676e6564204d6573736167653a0a3332000000006000908152601c829052603c8120610a04565b6000834710156128915760405162461bcd60e51b815260206004820152601d60248201527f437265617465323a20696e73756666696369656e742062616c616e63650000006044820152606401610ce5565b81516000036128e25760405162461bcd60e51b815260206004820181905260248201527f437265617465323a2062797465636f6465206c656e677468206973207a65726f6044820152606401610ce5565b8282516020840186f590506001600160a01b038116610a045760405162461bcd60e51b815260206004820152601960248201527f437265617465323a204661696c6564206f6e206465706c6f79000000000000006044820152606401610ce5565b6000836001600160a01b03163b60ad1461295f57506000610a04565b600061296a85612b63565b9050806001600160a01b03163b600003612988576000915050610a04565b836001600160a01b0316816001600160a01b0316146129ab576000915050610a04565b6000806000806129ba89612b75565b93509350935093506129d087868686868661194b565b6001600160a01b0316896001600160a01b031614955050505050509392505050565b60006001600160e01b03198216630271189760e51b1480610f3557506301ffc9a760e01b6001600160e01b0319831614610f35565b366000612a32612bcd565b915091509091565b6000807f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a0831115612a715750600090506003612af5565b6040805160008082526020820180845289905260ff881692820192909252606081018690526080810185905260019060a0016020604051602081039080840390855afa158015612ac5573d6000803e3d6000fd5b5050604051601f1901519150506001600160a01b038116612aee57600060019250925050612af5565b9150600090505b94509492505050565b612b0781612744565b6040516001600160a01b038216907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a250565b6060610a0483836040518060600160405280602781526020016139f060279139612c0f565b60006014600a600c843c505060005190565b60408051608080825260a0820190925260009182918291829182916020820181803683370190505090506080602d60208301883c80806020019051810190612bbd919061394f565b9450945094509450509193509193565b366000612bd9336111a6565b8015612be6575060143610155b15612c075760008036612bfa60148261398e565b92612a32939291906137f6565b600036612a32565b6060600080856001600160a01b031685604051612c2c91906135e5565b600060405180830381855af49150503d8060008114612c67576040519150601f19603f3d011682016040523d82523d6000602084013e612c6c565b606091505b50915091506110948683838760608315612ce7578251600003612ce0576001600160a01b0385163b612ce05760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e74726163740000006044820152606401610ce5565b50816109d8565b6109d88383815115612cfc5781518083602001fd5b8060405162461bcd60e51b8152600401610ce59190613140565b80356001600160e01b031981168114612d2e57600080fd5b919050565b600060208284031215612d4557600080fd5b610a0482612d16565b60008083601f840112612d6057600080fd5b5081356001600160401b03811115612d7757600080fd5b6020830191508360208260051b85010111156126e457600080fd5b60008060008060408587031215612da857600080fd5b84356001600160401b0380821115612dbf57600080fd5b612dcb88838901612d4e565b90965094506020870135915080821115612de457600080fd5b50612df187828801612d4e565b95989497509550505050565b6001600160a01b0381168114610d8257600080fd5b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f191681016001600160401b0381118282101715612e5057612e50612e12565b604052919050565b600082601f830112612e6957600080fd5b81356001600160401b03811115612e8257612e82612e12565b612e95601f8201601f1916602001612e28565b818152846020838601011115612eaa57600080fd5b816020850160208301376000918101602001919091529392505050565b60008060008060808587031215612edd57600080fd5b8435612ee881612dfd565b93506020850135612ef881612dfd565b92506040850135915060608501356001600160401b03811115612f1a57600080fd5b612f2687828801612e58565b91505092959194509250565b60008083601f840112612f4457600080fd5b5081356001600160401b03811115612f5b57600080fd5b6020830191508360208285010111156126e457600080fd5b600080600060408486031215612f8857600080fd5b8335925060208401356001600160401b03811115612fa557600080fd5b612fb186828701612f32565b9497909650939450505050565b600060208284031215612fd057600080fd5b5035919050565b60008060408385031215612fea57600080fd5b8235612ff581612dfd565b9150602083013561300581612dfd565b809150509250929050565b803560ff81168114612d2e57600080fd5b600080600080600080600060a0888a03121561303c57600080fd5b873561304781612dfd565b96506020880135955060408801356001600160401b038082111561306a57600080fd5b6130768b838c01612f32565b909750955085915061308a60608b01613010565b945060808a01359150808211156130a057600080fd5b818a0191508a601f8301126130b457600080fd5b8135818111156130c357600080fd5b8b60206060830285010111156130d857600080fd5b60208301945080935050505092959891949750929550565b60005b8381101561310b5781810151838201526020016130f3565b50506000910152565b6000815180845261312c8160208601602086016130f0565b601f01601f19169290920160200192915050565b602081526000610a046020830184613114565b6000806000806060858703121561316957600080fd5b843593506020850135925060408501356001600160401b0381111561318d57600080fd5b612df187828801612f32565b6000602082840312156131ab57600080fd5b8135610a0481612dfd565b6000806000606084860312156131cb57600080fd5b83356001600160401b038111156131e157600080fd5b840161016081870312156131f457600080fd5b95602085013595506040909401359392505050565b6000806020838503121561321c57600080fd5b82356001600160401b0381111561323257600080fd5b61323e85828601612d4e565b90969095509350505050565b6000602080830181845280855180835260408601915060408160051b870101925083870160005b8281101561329f57603f1988860301845261328d858351613114565b94509285019290850190600101613271565b5092979650505050505050565b600080604083850312156132bf57600080fd5b82356132ca81612dfd565b915060208301356001600160401b038111156132e557600080fd5b6132f185828601612e58565b9150509250929050565b60008060008060006080868803121561331357600080fd5b853561331e81612dfd565b94506020860135935060408601356001600160401b0381111561334057600080fd5b61334c88828901612f32565b909450925061335f905060608701613010565b90509295509295909350565b60008060006040848603121561338057600080fd5b833561338b81612dfd565b925060208401356001600160401b03811115612fa557600080fd5b600080600080606085870312156133bc57600080fd5b84356133c781612dfd565b93506020850135925060408501356001600160401b0381111561318d57600080fd5b600082601f8301126133fa57600080fd5b813560206001600160401b0382111561341557613415612e12565b8160051b613424828201612e28565b928352848101820192828101908785111561343e57600080fd5b83870192505b8483101561193657823582529183019190830190613444565b600080600080600060a0868803121561347557600080fd5b853561348081612dfd565b9450602086013561349081612dfd565b935060408601356001600160401b03808211156134ac57600080fd5b6134b889838a016133e9565b945060608801359150808211156134ce57600080fd5b6134da89838a016133e9565b935060808801359150808211156134f057600080fd5b506134fd88828901612e58565b9150509295509295909350565b6000806040838503121561351d57600080fd5b823561352881612dfd565b915061353660208401612d16565b90509250929050565b600080600080600060a0868803121561355757600080fd5b853561356281612dfd565b9450602086013561357281612dfd565b9350604086013592506060860135915060808601356001600160401b0381111561359b57600080fd5b6134fd88828901612e58565b60006bffffffffffffffffffffffff19808760601b16835284866014850137848301818560601b166014820152602881019250505095945050505050565b600082516135f78184602087016130f0565b9190910192915050565b634e487b7160e01b600052603260045260246000fd5b8015158114610d8257600080fd5b60006020828403121561363757600080fd5b8135610a0481613617565b634e487b7160e01b600052601160045260246000fd5b60006001820161366a5761366a613642565b5060010190565b60006020828403121561368357600080fd5b8151610a0481613617565b6000602082840312156136a057600080fd5b8151610a0481612dfd565b6020808252602c908201527f46756e6374696f6e206d7573742062652063616c6c6564207468726f7567682060408201526b19195b1959d85d1958d85b1b60a21b606082015260800190565b6020808252602c908201527f46756e6374696f6e206d7573742062652063616c6c6564207468726f7567682060408201526b6163746976652070726f787960a01b606082015260800190565b60008235607e198336030181126135f757600080fd5b6000808335601e1984360301811261377057600080fd5b8301803591506001600160401b0382111561378a57600080fd5b6020019150368190038213156126e457600080fd5b6000602082840312156137b157600080fd5b610a0482613010565b6000602082840312156137cc57600080fd5b5051919050565b80820180821115610f3557610f35613642565b8183823760009101908152919050565b6000808585111561380657600080fd5b8386111561381357600080fd5b5050820193919092039150565b80356020831015610f3557600019602084900360031b1b1692915050565b634e487b7160e01b600052602160045260246000fd5b6bffffffffffffffffffffffff198460601b168152818360148301376000910160140190815292915050565b60008060006060848603121561389557600080fd5b8351925060208401516138a781612dfd565b80925050604084015190509250925092565b600084516138cb8184602089016130f0565b606085901b6001600160601b03191690830190815283516138f38160148401602088016130f0565b0160140195945050505050565b83815260406020820152816040820152818360608301376000818301606090810191909152601f909201601f1916010192915050565b8281526040602082015260006109d86040830184613114565b6000806000806080858703121561396557600080fd5b8451935060208501519250604085015161397e81612dfd565b6060959095015193969295505050565b81810381811115610f3557610f3561364256fe3314601d573d3dfd5b363d3d373d3d6014360360143d5160601c5af43d6000803e80603e573d6000fd5b3d6000f3360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a2646970667358221220622e8fd59d5b1eb899f493e88d5ea40e561702143ac983ecc5c3e4ecaa8a4f2864736f6c634300081100330000000000000000000000005ff137d4b0fdcd49dca30c7cf57e578a026d2789000000000000000000000000ca1167915584462449ee5b4ea51c37fe81ecdccd000000000000000000000000000000006551c19487814612e58fe068137757580000000000000000000000002fe5ccb0d7ea195feb87987d3573f9fcce2b5d57' };

describe('$Crea Token', function () {
  prepare();

  before(async function () {
    this.accounts.beneficiary = this.accounts.shift();
    this.accounts.user        = this.accounts.shift();
    this.accounts.other       = this.accounts.shift();
  });

  beforeEach(async function () {
    // Deploy factory at 0x4e59b44847b379578588920ca78fbf26c0b4956c
    const { from, gasPrice, gasLimit } = ethers.utils.parseTransaction(FACTORY.tx);
    await this.accounts.admin.sendTransaction({ to: from, value: gasPrice.mul(gasLimit) });
    await ethers.provider.sendTransaction(FACTORY.tx);
    // Deploy ERC-6551 registry
    await this.accounts.admin.sendTransaction({ to: FACTORY.address, data: REGISTRY.data });
    await this.accounts.admin.sendTransaction({ to: FACTORY.address, data: PROXY.data });
    await this.accounts.admin.sendTransaction({ to: FACTORY.address, data: ACCOUNT.data });
    this.registry = await utils.attach('ERC6551Registry', REGISTRY.address);

    // Mock
    this.mock = await utils.deploy('GiftCardRegistry', [name, symbol]);
    await this.mock.setBeneficiary(this.accounts.beneficiary.address);
    await this.mock.setMintFee(fee);
    await this.mock.setBaseURI(uri);

    this.chainId = await ethers.provider.getNetwork().then(({ chainId }) => chainId);

    this.getAccount = (tokenId) => this.mock.getAccountForToken(tokenId).then(address => utils.attach('ERC6551Account', address));
  });

  it('sanity: registry exists', async function () {
    expect(await ethers.provider.getCode(FACTORY.address)).to.not.equal('0x');
    expect(await ethers.provider.getCode(REGISTRY.address)).to.not.equal('0x');
  });

  it('deployment check', async function () {
    expect(await this.mock.name()).to.equal(name);
    expect(await this.mock.symbol()).to.equal(symbol);
    expect(await this.mock.owner()).to.equal(this.accounts.admin.address);
    expect(await this.mock.registry()).to.equal(REGISTRY.address);
    expect(await this.mock.beneficiary()).to.equal(this.accounts.beneficiary.address);
    expect(await this.mock.mintFee()).to.equal(fee);
    expect(await this.mock.newTokenId()).to.equal(0n);
  });

  describe('mint', function () {
    it('missing fees', async function () {
      await expect(this.mock.connect(this.accounts.user).mint(this.accounts.user.address, { value: 0n }))
        .to.be.revertedWith('Invalid payment');
    });

    describe('with fees', function () {
      it('transfers eth to beneficiary', async function () {
        await expect(() => this.mock.connect(this.accounts.user).mint(this.accounts.user.address, { value: fee }))
          .to.changeEtherBalances([ this.accounts.user, this.accounts.beneficiary ], [ fee.mul(-1), fee ])
      });

      it('mint token and creates account', async function () {
        for (const _ of Array(10).fill()) {
          const tokenId = await this.mock.newTokenId();
          const tokenAccount = await this.getAccount(tokenId);

          // check account does not exist
          expect(await ethers.provider.getCode(tokenAccount.address)).to.equal('0x');

          // check mint does not revert
          await expect(this.mock.connect(this.accounts.user).mint(this.accounts.user.address, { value: fee }))
            .to.emit(this.mock, 'Transfer')
            .withArgs(ethers.constants.AddressZero, this.accounts.user.address, tokenId)
            .to.emit(this.registry, 'ERC6551AccountCreated')
            .withArgs(tokenAccount.address, PROXY.address, ethers.constants.HashZero, this.chainId, this.mock.address, tokenId);

          expect(await this.mock.tokenURI(tokenId)).to.equal(uri + tokenId.toString());

          // check account creation
          expect(await ethers.provider.getCode(tokenAccount.address)).to.not.equal('0x');

          // check account prediction match
          expect(
            await this.registry.account(
              PROXY.address,
              ethers.constants.HashZero,
              this.chainId,
              this.mock.address,
              tokenId,
            )
          ).to.equal(
            await this.mock.getAccountForToken(tokenId)
          );

          // check getters
          const result = await tokenAccount.token();
          expect(result[0]).to.equal(this.chainId);
          expect(result[1]).to.equal(this.mock.address);
          expect(result[2]).to.equal(tokenId);
          expect(await tokenAccount.owner()).to.equal(this.accounts.user.address);
        }
      });

      it('does not revert if account is already created', async function () {
        const tokenId = await this.mock.newTokenId();
        const tokenAccount = await this.getAccount(tokenId);

        // create account in anticipation
        await expect(this.registry.createAccount(PROXY.address, ethers.constants.HashZero, this.chainId, this.mock.address, tokenId))
          .to.emit(this.registry, 'ERC6551AccountCreated')
          .withArgs(tokenAccount.address, PROXY.address, ethers.constants.HashZero, this.chainId, this.mock.address, tokenId);

        // check account creation
        expect(await ethers.provider.getCode(tokenAccount.address)).to.not.equal('0x');

        // check mint does not revert
        await expect(this.mock.connect(this.accounts.user).mint(this.accounts.user.address, { value: fee }))
          .to.emit(this.mock, 'Transfer')
          .withArgs(ethers.constants.AddressZero, this.accounts.user.address, tokenId)
          .to.not.emit(this.registry, 'ERC6551AccountCreated')
      });

      it('too much fees', async function () {
        const tokenId = await this.mock.newTokenId();
        const tokenAccount = await this.getAccount(tokenId);

        await expect(() => this.mock.connect(this.accounts.user).mint(this.accounts.user.address, { value: fee.add(100) }))
          .to.changeEtherBalances([ this.accounts.user, this.accounts.beneficiary, tokenAccount ], [ fee.add(100).mul(-1), fee, 100 ])
      });
    });
  });

  describe('admin operation', function () {
    beforeEach(async function () {
      await this.mock.mint(this.accounts.user.address, { value: fee });
    });

    describe('URI', function () {
      const newURI = 'https://someotherapi.com/';

      it('admin can update URI', async function () {
        expect(await this.mock.tokenURI(0)).to.equal(uri + '0');

        await expect(this.mock.connect(this.accounts.admin).setBaseURI(newURI))
          .to.emit(this.mock, 'BatchMetadataUpdate')
          .withArgs(0, ethers.constants.MaxUint256);

          expect(await this.mock.tokenURI(0)).to.equal(newURI + '0');
        });

      it('other cannot update URI', async function () {
        await expect(this.mock.connect(this.accounts.other).setBaseURI(newURI))
          .to.be.revertedWith('Ownable: caller is not the owner');
      });

    });
    describe('beneficiary', function () {
      it('admin can update beneficiary', async function () {
        await expect(this.mock.connect(this.accounts.admin).setBeneficiary(this.accounts.other.address))
          .to.emit(this.mock, 'BeneficiaryUpdate')
          .withArgs(this.accounts.other.address);

        expect(await this.mock.beneficiary()).to.equal(this.accounts.other.address);
      });

      it('other cannot update beneficiary', async function () {
        await expect(this.mock.connect(this.accounts.other).setBeneficiary(this.accounts.other.address))
          .to.be.revertedWith('Ownable: caller is not the owner');
      });
    });
    describe('mint fee', function () {
      const newMintFee = 420n;

      it('admin can update mint fee', async function () {
        await expect(this.mock.connect(this.accounts.admin).setMintFee(newMintFee))
          .to.emit(this.mock, 'MintFeeUpdate')
          .withArgs(newMintFee);

        expect(await this.mock.mintFee()).to.equal(newMintFee);
      });

      it('other cannot update mint fee', async function () {
        await expect(this.mock.connect(this.accounts.other).setMintFee(newMintFee))
          .to.be.revertedWith('Ownable: caller is not the owner');
      });
    });
  });

  describe('account operations', function () {
    beforeEach(async function () {
      this.tokenId = await this.mock.newTokenId();
      this.tokenAccount = await this.getAccount(this.tokenId);

      await this.mock.mint(this.accounts.user.address, { value: fee });
    });

    it('check signer validity', async function () {
      expect(await this.tokenAccount.isValidSigner(this.accounts.user.address, "0x12345678"))
        .to.equal(this.tokenAccount.interface.getSighash('isValidSigner'));

      expect(await this.tokenAccount.isValidSigner(this.accounts.other.address, "0x12345678"))
        .to.equal('0x00000000');
    });

    it('check signature validity', async function () {
      const message = "hello world!";
      const hash = ethers.utils.hashMessage(message);
      const userSign = await this.accounts.user.signMessage(message);
      const otherSign = await this.accounts.other.signMessage(message);

      expect(await this.tokenAccount.isValidSignature(hash, userSign))
        .to.equal(this.tokenAccount.interface.getSighash('isValidSignature'));

        expect(await this.tokenAccount.isValidSignature(hash, otherSign))
        .to.equal('0x00000000');
    });

    it.skip('signature verification support chainning (not available with standard wallet)', async function () {
      const message = "hello world!";
      const hash = ethers.utils.hashMessage(message);
      const sign = await this.accounts.user.signMessage(message);

      let account = this.accounts.user;
      for (const _ of Array(10).fill()) {
        account = await this.mock.mint(account.address, { value: fee })
          .then(tx => tx.wait())
          .then(receipt => receipt.events.find(ev => ev.event == 'Transfer').args.tokenId)
          .then(tokenId => this.getAccount(tokenId));

        expect(await account.isValidSignature(hash, sign))
          .to.equal(this.tokenAccount.interface.getSighash('isValidSignature'));
      }
    });

    it('execute is protected', async function () {
      await expect(this.tokenAccount.connect(this.accounts.other).execute(ethers.constants.AddressZero, 0, '0x', 0))
        .to.be.reverted; // custom error
    });

    it('execute bubbles reverts', async function () {
      // Not enough tokens for operation
      const data = this.token.interface.encodeFunctionData('transfer', [ this.accounts.other.address, ethers.constants.MaxUint256 ]);
      await expect(this.tokenAccount.connect(this.accounts.user).execute(this.token.address, 0, data, 0))
        .to.be.revertedWith('ERC20: transfer amount exceeds balance');
    });

    it('account receive and spend ether', async function () {
      const value = 23_000n;

      // receive
      await expect(() => this.accounts.admin.sendTransaction({ to: this.tokenAccount.address, value }))
        .to.changeEtherBalances([ this.accounts.admin, this.tokenAccount ], [ -value, value ]);

      // spend
      await expect(() => this.tokenAccount.connect(this.accounts.user).execute(this.accounts.other.address, value, '0x', 0))
        .to.changeEtherBalances([ this.tokenAccount, this.accounts.other ], [ -value, value ]);
    });

    it('account receive and spend erc20', async function () {
      const value = 23_000n;

      // receive
      await expect(() => this.token.transfer(this.tokenAccount.address, value))
        .to.changeTokenBalances(this.token, [ this.accounts.admin, this.tokenAccount ], [ -value, value ]);

      // spend
      const data = this.token.interface.encodeFunctionData('transfer', [ this.accounts.other.address, value ]);
      await expect(() => this.tokenAccount.connect(this.accounts.user).execute(this.token.address, 0, data, 0))
        .to.changeTokenBalances(this.token, [ this.tokenAccount, this.accounts.other ], [ -value, value ]);
    });
  });
});
